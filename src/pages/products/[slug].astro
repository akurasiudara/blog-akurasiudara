---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import ShareButtons from '../../components/ShareButtons.astro';
import { marked } from 'marked';
import '../../styles/markdown.css';

export async function getStaticPaths() {
	const { data: products } = await supabase.from('products').select('slug');
	return products?.filter(p => p.slug).map(({ slug }) => ({
		params: { slug }
	})) || [];
}

const { slug } = Astro.params;
const { data: product } = await supabase.from('products').select('*').eq('slug', slug).single();

if (!product) {
    return Astro.redirect('/404');
}

// Use the same fallback logic as the blog posts for consistency
const imageList = Array.isArray(product.images) && product.images.length > 0
    ? product.images
    : [product.image_url_old || 'https://via.placeholder.com/800x600.png?text=No+Image'];

// CORRECTED: The variable is now named renderedContent
const renderedContent = product.description ? await marked.parse(product.description) : '';

const pageUrl = Astro.url.href;
const shareText = `Lihat produk ini: ${product.name}`;
---
<Layout title={product.name}>
	<div class="row justify-content-center">
		<div class="col-lg-8">
			<header class="mb-4">
				<h1 class="display-5 fw-bold">{product.name}</h1>
			</header>

			<div id="productImageSlider" class="carousel slide shadow-sm rounded-3 mb-4" data-bs-ride="carousel">
				<div class="carousel-indicators">
					{imageList.map((_, index) => (
						<button
							type="button"
							data-bs-target="#productImageSlider"
							data-bs-slide-to={index}
							class={index === 0 ? 'active' : ''}
							aria-current={index === 0 ? 'true' : 'false'}
							aria-label={`Slide ${index + 1}`}
						></button>
					))}
				</div>
				<div class="carousel-inner rounded-3">
					{imageList.map((imageUrl, index) => (
						<div class={`carousel-item ${index === 0 ? 'active' : ''}`}>
							<img src={imageUrl} class="d-block w-100" alt={`Gambar produk ${index + 1}`} style="aspect-ratio: 4 / 3; object-fit: cover;">
						</div>
					))}
				</div>
				<button class="carousel-control-prev" type="button" data-bs-target="#productImageSlider" data-bs-slide="prev">
					<span class="carousel-control-prev-icon" aria-hidden="true"></span>
					<span class="visually-hidden">Previous</span>
				</button>
				<button class="carousel-control-next" type="button" data-bs-target="#productImageSlider" data-bs-slide="next">
					<span class="carousel-control-next-icon" aria-hidden="true"></span>
					<span class="visually-hidden">Next</span>
				</button>
			</div>
			
			<article class="prose">
				<Fragment set:html={renderedContent} />
			</article>

			<div class="mt-5 d-grid gap-2 col-md-8 mx-auto">
				<a href={product.whatsapp_link} target="_blank" class="btn btn-primary btn-lg">
					Pesan via WhatsApp
				</a>
			</div>

            <hr class="my-5">
            <ShareButtons url={pageUrl} text={shareText} />
		</div>
	</div>
</Layout>