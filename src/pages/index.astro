---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import { marked } from 'marked';

// Fungsi untuk format tanggal
function formatDate(dateString) {
	const options = { day: '2-digit', month: 'long', year: 'numeric' };
	return new Date(dateString).toLocaleDateString('id-ID', options);
}

// Fungsi untuk estimasi waktu baca
function calculateReadingTime(content) {
    if (!content) return '1 min';
    const wordsPerMinute = 200;
    const words = content.trim().split(/\s+/).length;
    return `${Math.ceil(words / wordsPerMinute)} min`;
}

// Mengambil semua data dari Supabase
const [linksRes, productsRes, postsRes, allPostsRes] = await Promise.all([
    supabase.from('links').select('*').order('sort_order'),
    supabase.from('products').select('*, slug, images, image_url_old'),
    supabase.from('posts').select('*, content, category').limit(3).order('created_at', { ascending: false }),
    supabase.from('posts').select('category')
]);

const links = linksRes.data;
const rawProducts = productsRes.data;
const rawPosts = postsRes.data;

// Memproses data produk
const products = await Promise.all(
  rawProducts?.map(async (product) => {
    const primaryImage =
      Array.isArray(product.images) && product.images.length > 0
        ? product.images[0]
        : product.image_url_old ||
          "https://via.placeholder.com/400x300.png?text=No+Image";

    // PERBAIKAN: Buat URL WhatsApp di sini
    const whatsAppNumber = '628161112148';
    // Gunakan URL dasar situs Anda. Ganti jika perlu.
    const productUrl = `${Astro.site}products/${product.slug}`; 
    const baseMessage = `Assalamu'alaikum, saya tertarik dengan produk ${productUrl}`;
    const encodedMessage = encodeURIComponent(baseMessage);
    const finalWhatsAppUrl = `https://wa.me/${whatsAppNumber}?text=${encodedMessage}`;

    return {
      ...product,
      primaryImage,
      finalWhatsAppUrl, // Tambahkan URL WhatsApp ke objek produk
      descriptionHtml: product.description
        ? await marked.parse(product.description)
        : "<p></p>",
    };
  }) || []
);

const posts = rawPosts?.map((post) => ({
  ...post,
  readingTime: calculateReadingTime(post.content),
}));

const allCategories = allPostsRes.data?.map(post => post.category).filter(Boolean);
const uniqueCategories = [...new Set(allCategories)];
---
<Layout title="Beranda - Akurasi Udara">
	<div class="text-center mb-5">
		<div class="g-one-wrapper mx-auto">
			<img
			class="rounded-circle shadow-lg"
			width="120"
			height="120"
			src="/images/Palestine.png"
			alt="Foto profil"
			/>
		</div>
		<h1 class="display-4 fw-bold mt-4">Akurasi Udara</h1>
		<p class="lead text-secondary">Selamat datang di ruang digital saya.</p>
	</div>

	<div class="row justify-content-center">
		<div class="col-lg-8">
			<section class="d-grid gap-3 mb-5">
				{
				links?.map((link) => (
					<a
					href={link.url}
					target="_blank"
					class="btn btn-warning btn-lg btn-flat"
					>
					{link.title}
					</a>
				))
				}
			</section>

			<section class="mb-5">
				<h2 class="display-6 fw-bold border-bottom pb-2 mb-4">Jualan Saya</h2>
				<div class="row row-cols-2 g-2 g-md-4">
				{
					products?.map((product) => (
					<div class="col">
						<div
						class="card h-100 product-card border-light-subtle"
						style="cursor: pointer;"
						data-bs-toggle="modal"
						data-bs-target="#productModal"
						data-name={product.name}
						data-image={product.primaryImage}
						data-description-html={product.descriptionHtml}
						data-link={product.finalWhatsAppUrl} data-slug={product.slug}
						>
						<img
							src={product.primaryImage}
							class="card-img-top"
							alt={product.name}
							style="height: 120px; object-fit: cover;"
						/>
						<div class="card-body">
							<h5 class="card-title text-center small">{product.name}</h5>
						</div>
						</div>
					</div>
					))
				}
				</div>
			</section>

			<section>
				<h2 class="display-6 fw-bold border-bottom pb-2 mb-4">
				Tulisan Terbaru
				</h2>
				<div class="list-group list-group-flush">
				{
					posts?.map((post, index) => (
					<div class="list-group-item bg-transparent px-0 py-3">
						<div class="d-flex w-100 align-items-center">
						<span class="fs-4 me-3 text-secondary">
							{(index + 1).toString().padStart(2, "0")}.
						</span>
						<div class="flex-grow-1">
							<h5 class="mb-1">
							<a
								href={`/blog/${post.slug}`}
								class="text-reset text-decoration-none"
							>
								{post.title}
							</a>
							</h5>
							<div class="d-flex align-items-center text-body-secondary small mt-2">
							<a
								href={`/blog/kategori/${post.category}`}
								class="text-reset text-decoration-none me-3"
							>
								<i class="bi bi-tag-fill me-1" />
								{post.category || "Umum"}
							</a>
							<span class="me-3">
								<i class="bi bi-calendar-event me-1" />
								{formatDate(post.created_at)}
							</span>
							<span>
								<i class="bi bi-eye-fill me-1" /> {post.readingTime}
							</span>
							</div>
						</div>
						</div>
					</div>
					))
				}
				</div>
				<div class="text-center mt-4">
				<a
					href="/blog"
					class="btn btn-link text-secondary text-decoration-none"
					>Lihat Postingan Lainnya &rarr;</a
				>
				</div>
				<div class="mt-5 border-top pt-4">
					<div class="d-flex flex-wrap gap-2 justify-content-center">
						{uniqueCategories.map(category => (
							<a href={`/blog/kategori/${category}`} class="text-secondary text-decoration-none">
								#{category}
							</a>
						))}
					</div>
				</div>
			</section>
		</div>
	</div>

	<div class="modal fade" id="productModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered modal-xl">
			<div class="modal-content overflow-hidden">
				<div class="row g-0 align-items-stretch">
					<div class="col-md-6 modal-image-col">
						<div class="aspect-ratio-container">
							<img id="modal-product-image" src="" class="aspect-ratio-item" alt=""/>
						</div>
					</div>
					<div class="col-md-6 d-flex flex-column p-4 modal-text-col">
						<div class="d-flex justify-content-between align-items-start">
							<h4 class="modal-title mb-3" id="modal-product-name"></h4>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-description-wrapper prose">
							<div id="modal-product-description"></div>
						</div>
						<div class="d-flex gap-2 mt-auto pt-3">
							<a id="modal-product-slug-link" href="#" class="btn btn-warning w-100 btn-lg">Lihat Selengkapnya</a>
							<a id="modal-product-wa-link" href="#" target="_blank" class="btn btn-success btn-lg flex-shrink-0"><i class="bi bi-whatsapp"></i></a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script is:inline>
	document.addEventListener("DOMContentLoaded", () => {
		const productModal = document.getElementById("productModal");
		productModal.addEventListener("show.bs.modal", (event) => {
			const card = event.relatedTarget;
			const dataset = card.dataset;
			const modalTitle = productModal.querySelector(".modal-title");
			const modalImage = productModal.querySelector("#modal-product-image");
			const modalDescription = productModal.querySelector("#modal-product-description");
			const modalSlugLink = productModal.querySelector("#modal-product-slug-link");
			const modalWaLink = productModal.querySelector("#modal-product-wa-link");
			
			modalTitle.textContent = dataset.name;
			modalImage.src = dataset.image;
			modalDescription.innerHTML = dataset.descriptionHtml;
			// PERBAIKAN: Ambil link WhatsApp yang sudah jadi dari data-link
			modalWaLink.href = dataset.link; 
			modalSlugLink.href = `/products/${dataset.slug}`;
		});
	});
</script>