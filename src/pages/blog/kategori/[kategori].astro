---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';

// PERBAIKAN: Tambahkan fungsi getStaticPaths
export async function getStaticPaths() {
    // 1. Ambil semua data kategori dari Supabase
    const { data: posts } = await supabase.from('posts').select('category');

    // 2. Buat daftar kategori yang unik (tidak ada duplikat)
    const uniqueCategories = [...new Set(posts?.map(post => post.category).filter(Boolean))];

    // 3. Kembalikan daftar path untuk Astro
    return uniqueCategories.map(kategori => {
        return {
            params: { kategori: kategori }
        };
    });
}

const DEFAULT_THUMBNAIL = 'https://images.unsplash.com/photo-1714464702947-36fb39f3bde4?q=80&w=880&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';

function formatDate(dateString) {
	const options = { day: '2-digit', month: 'long', year: 'numeric' };
	return new Date(dateString).toLocaleDateString('id-ID', options);
}

function calculateReadingTime(content) {
    if (!content) return '1 min';
    const wordsPerMinute = 200;
    const words = content.trim().split(/\s+/).length;
    return `${Math.ceil(words / wordsPerMinute)} min`;
}

const { kategori } = Astro.params;

const { data } = await supabase.from('posts')
    .select('*, image_url, content, category')
    .eq('category', kategori)
    .order('created_at', { ascending: false });

const posts = data?.map(post => ({
    ...post,
    image_url: post.image_url || DEFAULT_THUMBNAIL,
    readingTime: calculateReadingTime(post.content)
}));
---
<Layout title={`Postingan Kategori: ${kategori}`}>
	<div class="text-center mb-5">
		<h3 class="display-4 fw-bold">Menampilkan postingan dalam kategori: {kategori}</h3>
	</div>

	<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
		{posts?.length > 0 ? (
			posts.map(post => (
				<div class="col">
					<a href={`/blog/${post.slug}`} class="text-decoration-none">
						<div class="card h-100 shadow-sm">
							<img src={post.image_url} class="card-img-top" alt={post.title} style="height: 200px; object-fit: cover;">
							<div class="card-body d-flex flex-column">
								<h5 class="card-title">{post.title}</h5>
								<p class="card-text text-secondary flex-grow-1">{post.excerpt}</p>
								<div class="d-flex align-items-center text-body-secondary small mt-auto pt-2">
									<span class="me-3 text-nowrap"><i class="bi bi-calendar-event me-1"></i> {formatDate(post.created_at)}</span>
									<span class="ms-auto text-nowrap"><i class="bi bi-eye-fill me-1"></i> {post.readingTime}</span>
								</div>
							</div>
						</div>
					</a>
				</div>
			))
		) : (
			<p class="text-center text-secondary">Tidak ada postingan yang ditemukan dalam kategori ini.</p>
		)}
	</div>
</Layout>

