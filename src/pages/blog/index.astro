---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

const DEFAULT_THUMBNAIL = 'https://images.unsplash.com/photo-1714464702947-36fb39f3bde4?q=80&w=880&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';

function formatDate(dateString) {
	const options = { day: '2-digit', month: 'long', year: 'numeric' };
	return new Date(dateString).toLocaleDateString('id-ID', options);
}

function calculateReadingTime(content) {
    if (!content) return '1 min';
    const wordsPerMinute = 200;
    const words = content.trim().split(/\s+/).length;
    return `${Math.ceil(words / wordsPerMinute)} min`;
}

const { data } = await supabase.from('posts').select('*, image_url, content, category').order('created_at', { ascending: false });

const posts = data?.map(post => ({
    ...post,
    image_url: post.image_url || DEFAULT_THUMBNAIL,
    readingTime: calculateReadingTime(post.content)
}));

const categoryCounts = posts?.reduce((acc, post) => {
    if (post.category) {
        acc[post.category] = (acc[post.category] || 0) + 1;
    }
    return acc;
}, {});
const uniqueCategories = Object.keys(categoryCounts || {});
---
<Layout title="Blog - Akurasi Udara">
	<div class="text-center mb-5">
		<h1 class="display-4 fw-bold">Blog</h1>
		<p class="lead text-secondary">Kumpulan tulisan yang pernah saya buat.</p>
	</div>

	<div class="mb-5 text-center">
		<h2 class="h4 mb-3">Telusuri Kategori</h2>
		<div class="d-flex flex-wrap justify-content-center gap-2">
			<a href="/blog" class="btn btn-primary">
				Semua Postingan <span class="badge text-bg-light">{posts?.length}</span>
			</a>
			{uniqueCategories.map(category => (
				<a href={`/blog/kategori/${category}`} class="btn btn-outline-secondary">
					{category} <span class="badge text-bg-secondary">{categoryCounts[category]}</span>
				</a>
			))}
		</div>
	</div>

	<hr class="mb-5">

	<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
		{posts?.map(post => (
			<div class="col">
				<a href={`/blog/${post.slug}`} class="text-decoration-none">
					<div class="card h-100">
						<img src={post.image_url} class="card-img-top" alt={post.title} style="height: 200px; object-fit: cover;">
						<div class="card-body d-flex flex-column">
							<h5 class="card-title">{post.title}</h5>
							<p class="card-text text-secondary flex-grow-1">{post.excerpt}</p>
							<div class="d-flex align-items-center text-body-secondary small mt-auto pt-2">
								<a href={`/blog/kategori/${post.category}`} class="text-reset text-decoration-none me-3">
									<i class="bi bi-tag-fill me-1"></i> {post.category || 'Umum'}
								</a>
								<span class="me-3 text-nowrap"><i class="bi bi-calendar-event me-1"></i> {formatDate(post.created_at)}</span>
								<span class="ms-auto text-nowrap"><i class="bi bi-eye-fill me-1"></i> {post.readingTime}</span>
							</div>
						</div>
					</div>
				</a>
			</div>
		))}
	</div>
</Layout>